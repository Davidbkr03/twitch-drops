<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Drop Automator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            margin-bottom: 30px;
            color: white;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            text-align: left;
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .hamburger-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .hamburger-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .hamburger-btn span {
            display: block;
            height: 3px;
            width: 100%;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1000;
            margin-top: 5px;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-btn {
            width: 100%;
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
        }

        .dropdown-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .dropdown-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .dropdown-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #333;
        }

        .dropdown-label input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* When debug mode is off, expand the remaining card to full width */
        body:not(.debug-mode) .dashboard {
            grid-template-columns: 1fr;
        }

        body:not(.debug-mode) .dashboard .card:not(.debug-only) {
            grid-column: 1;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-offline {
            background-color: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }

        .browser-preview {
            grid-column: 1 / -1;
        }

        .browser-preview img {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .preview-placeholder {
            width: 100%;
            height: 400px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.2rem;
            border: 2px dashed #ccc;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
            font-size: 1.1rem;
        }

        .log-container {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        /* When debug mode is on, make log container take full width */
        body.debug-mode .log-container {
            width: 100%;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }

        .log-level-info {
            color: #4CAF50;
        }

        .log-level-warning {
            color: #FF9800;
        }

        .log-level-success {
            color: #28a745;
        }

        .debug-only {
            display: none;
        }

        .debug-mode .debug-only {
            display: block;
        }

        .debug-mode .debug-only.card {
            display: flex;
            flex-direction: column;
        }

        .log-level-error {
            color: #f44336;
        }

        .settings-grid {
            display: grid;
            gap: 20px;
            margin-top: 15px;
        }

        .setting-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .setting-label {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            margin-bottom: 5px;
        }

        .setting-label input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .setting-description {
            color: #666;
            font-size: 0.9rem;
            margin-left: 30px;
        }

        .dev-options {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .dev-options.show {
            display: block;
        }

        .dev-options h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .dev-separator {
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 20px 0;
            border-radius: 1px;
        }

        .settings-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        /* When debug mode is off, expand settings to use more space */
        body:not(.debug-mode) .settings-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        body:not(.debug-mode) .setting-item {
            padding: 20px;
        }

        .settings-note {
            display: block;
            margin-top: 10px;
            color: #666;
            font-size: 0.9rem;
            font-style: italic;
        }

        /* Drops Progress Styles */
        .drops-progress {
            grid-column: 1 / -1;
        }

        .current-working-section {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
        }

        .current-working-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }

        .current-working-icon {
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }

        .current-working-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .current-working-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-working-media-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .current-working-media {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .current-working-streamer-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .current-working-details {
            flex: 1;
        }

        .current-working-item-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .current-working-streamer {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 3px;
        }

        .current-working-status {
            font-size: 0.8rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drops-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .drops-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .section-title.in-progress {
            color: #ff9800;
        }

        .section-title.not-started {
            color: #9e9e9e;
        }

        .section-title.completed {
            color: #4caf50;
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .section-count {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: auto;
        }

        .drops-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .drop-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .drop-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .drop-card.in-progress {
            border-color: #ff9800;
        }

        .drop-card.not-started {
            border-color: #9e9e9e;
            opacity: 0.8;
        }

        .drop-card.completed {
            border-color: #4caf50;
        }

        .drop-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .drop-media-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .media-box {
            position: relative;
        }

        .drop-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
        }

        .drop-streamer-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
        }

        .drop-image-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .drop-info {
            flex: 1;
        }

        .drop-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .drop-streamer {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 3px;
        }

        .drop-type {
            font-size: 0.8rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drop-progress-title {
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 500;
            margin-top: 2px;
            font-style: italic;
        }

        .drop-progress {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.in-progress {
            background: linear-gradient(90deg, #ff9800 0%, #ff5722 100%);
        }

        .progress-fill.completed {
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }

        .drop-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .drop-hours {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .drop-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-live {
            background: #f44336;
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: #9e9e9e;
        }

        .status-completed {
            background: #4caf50;
        }

        .no-drops {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px 20px;
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                justify-content: center;
            }

            .drops-grid {
                grid-template-columns: 1fr;
            }

            .drop-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>üéÆ Twitch Drop Automator</h1>
                    <p>Monitor and control your Twitch drop farming</p>
                </div>
                <div class="header-right">
                    <div class="dropdown">
                        <button class="hamburger-btn" onclick="toggleDropdown()" id="hamburgerBtn">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <div class="dropdown-content" id="dropdownContent">
                            <div class="dropdown-item">
                                <button class="dropdown-btn" onclick="checkForUpdates()" id="updateBtn">
                                    üîÑ Check for Updates
                                </button>
                            </div>
                            <div class="dropdown-item">
                                <label class="dropdown-label">
                                    <input type="checkbox" id="showDevOptionsToggle" onchange="toggleDevOptions()">
                                    Show Developer Options
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2><span class="status-indicator status-offline" id="statusIndicator"></span>Status</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Connection</div>
                        <div class="info-value" id="connectionStatus">Connecting...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Headless Mode</div>
                        <div class="info-value" id="headlessStatus">Unknown</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Last Update</div>
                        <div class="info-value" id="lastUpdate">Never</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Version</div>
                        <div class="info-value" id="appVersion">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="card debug-only">
                <h2>üìä Statistics</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Screenshots Captured</div>
                        <div class="info-value" id="screenshotCount">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Uptime</div>
                        <div class="info-value" id="uptime">00:00:00</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Web Interface</div>
                        <div class="info-value">Active</div>
                    </div>
                </div>
            </div>

            <div class="card browser-preview">
                <h2>üñ•Ô∏è Browser Preview</h2>
                <div id="browserPreview">
                    <div class="preview-placeholder">
                        Waiting for browser screenshot...
                    </div>
                </div>
            </div>

            <div class="card drops-progress">
                <h2>üéÅ Drops Progress</h2>
                
                <!-- Current Working Item -->
                <div class="current-working-section" id="currentWorkingSection" style="display: none;">
                    <h3 class="current-working-title">
                        <span class="current-working-icon">‚ö°</span>
                        Currently Working On
                    </h3>
                    <div class="current-working-item" id="currentWorkingItem">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="drops-container">
                    <div class="drops-section">
                        <h3 class="section-title in-progress">
                            <span class="section-icon">‚è≥</span>
                            In Progress
                            <span class="section-count" id="inProgressCount">0</span>
                        </h3>
                        <div class="drops-grid" id="inProgressDrops">
                            <div class="no-drops">No drops in progress</div>
                        </div>
                    </div>
                    
                    <div class="drops-section">
                        <h3 class="section-title not-started">
                            <span class="section-icon">‚è∏Ô∏è</span>
                            Not Started
                            <span class="section-count" id="notStartedCount">0</span>
                        </h3>
                        <div class="drops-grid" id="notStartedDrops">
                            <div class="no-drops">No drops available yet</div>
                        </div>
                    </div>
                    
                    <div class="drops-section">
                        <h3 class="section-title completed">
                            <span class="section-icon">‚úÖ</span>
                            Completed
                            <span class="section-count" id="completedCount">0</span>
                        </h3>
                        <div class="drops-grid" id="completedDrops">
                            <div class="no-drops">No drops completed yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è Settings</h2>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label class="setting-label">
                            <input type="checkbox" id="headlessToggle" onchange="updateSetting('headless', this.checked)">
                            Headless Mode
                        </label>
                        <span class="setting-description">Run browser in background without visible window</span>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">
                            <input type="checkbox" id="hideConsoleToggle" onchange="updateSetting('hide_console', this.checked)">
                            Hide Console
                        </label>
                        <span class="setting-description">Hide console window on startup</span>
                    </div>
                </div>
                
                <div class="dev-options" id="devOptions">
                    <div class="dev-separator"></div>
                    <h3>üîß Developer Options</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">
                                <input type="checkbox" id="testModeToggle" onchange="updateSetting('test_mode', this.checked)">
                                Test Mode
                            </label>
                            <span class="setting-description">Keep browser open for screenshot testing</span>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">
                                <input type="checkbox" id="debugModeToggle" onchange="updateSetting('debug_mode', this.checked)">
                                Debug Mode
                            </label>
                            <span class="setting-description">Show detailed debug information</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="btn btn-primary" onclick="applySettings()">Apply Settings</button>
                    <span class="settings-note">Some settings require restart to take effect</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="refreshStatus()">üîÑ Refresh Status</button>
            <button class="btn btn-secondary" onclick="window.location.reload()">üîÑ Reload Page</button>
            <a href="/api/status" class="btn btn-secondary" target="_blank">üìã API Status</a>
        </div>

        <div class="log-container debug-only" id="logContainer">
            <div class="log-entry">
                <span class="log-timestamp">[00:00:00]</span>
                <span class="log-level-info">INFO</span> Web interface loaded
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();
        let screenshotCount = 0;
        let startTime = Date.now();

        // Connection status
        socket.on('connect', function() {
            updateConnectionStatus('Connected', 'status-online');
            addLogEntry('Connected to Twitch Drop Automator', 'info');
        });

        socket.on('disconnect', function() {
            updateConnectionStatus('Disconnected', 'status-offline');
            addLogEntry('Disconnected from server', 'warning');
        });

        // Status updates
        socket.on('status', function(data) {
            addLogEntry(data.message, 'info');
        });

        // Drops updates via WebSocket
        socket.on('drops_update', function(data) {
            dropsData = data;
            updateDropsDisplay();
            addLogEntry('Drops data updated via WebSocket', 'info');
        });

        socket.on('drops_error', function(data) {
            addLogEntry('Drops update error: ' + data.error, 'error');
        });

        // Screenshot updates
        socket.on('screenshot', function(data) {
            screenshotCount++;
            document.getElementById('screenshotCount').textContent = screenshotCount;
            document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleTimeString();
            
            const preview = document.getElementById('browserPreview');
            const img = document.createElement('img');
            img.src = data.image;
            img.alt = 'Browser Screenshot';
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.borderRadius = '10px';
            img.style.border = '2px solid #e0e0e0';
            img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
            
            // Add error handling for image loading
            img.onerror = function() {
                console.error('Failed to load screenshot image');
                preview.innerHTML = '<div class="preview-placeholder">Failed to load screenshot</div>';
            };
            
            img.onload = function() {
                console.log('Screenshot loaded successfully');
                if (data.url) {
                    console.log('Screenshot URL:', data.url);
                }
            };
            
            preview.innerHTML = '';
            preview.appendChild(img);
        });

        // Update connection status
        function updateConnectionStatus(status, className) {
            document.getElementById('connectionStatus').textContent = status;
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator ${className}`;
        }

        // Add log entry
        function addLogEntry(message, level) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">${level.toUpperCase()}</span> ${message}
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Refresh status
        function refreshStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('headlessStatus').textContent = data.headless ? 'Enabled' : 'Disabled';
                    document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleTimeString();
                    if (data.version) {
                        document.getElementById('appVersion').textContent = data.version;
                    }
                    addLogEntry('Status refreshed', 'info');
                })
                .catch(error => {
                    addLogEntry('Failed to refresh status: ' + error, 'error');
                });
        }

        // Load settings from server
        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('headlessToggle').checked = data.headless;
                    document.getElementById('hideConsoleToggle').checked = data.hide_console;
                    document.getElementById('testModeToggle').checked = data.test_mode;
                    document.getElementById('debugModeToggle').checked = data.debug_mode;
                    
                    // Update debug mode visibility
                    updateDebugModeVisibility(data.debug_mode);
                })
                .catch(error => {
                    console.error('Failed to load settings:', error);
                });
        }

        // Update debug mode visibility
        function updateDebugModeVisibility(debugMode) {
            const body = document.body;
            if (debugMode) {
                body.classList.add('debug-mode');
            } else {
                body.classList.remove('debug-mode');
            }
        }

        // Update a setting
        function updateSetting(setting, value) {
            const data = {};
            data[setting] = value;
            
            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    addLogEntry(`${setting} updated to ${value}`, 'info');
                    
                    // Update debug mode visibility if debug_mode was changed
                    if (setting === 'debug_mode') {
                        updateDebugModeVisibility(value);
                    }
                } else {
                    addLogEntry(`Failed to update ${setting}: ${result.message}`, 'error');
                }
            })
            .catch(error => {
                addLogEntry(`Error updating ${setting}: ${error}`, 'error');
            });
        }

        // Dropdown toggle
        function toggleDropdown() {
            const dropdownContent = document.getElementById('dropdownContent');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            
            if (dropdownContent.classList.contains('show')) {
                dropdownContent.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            } else {
                dropdownContent.classList.add('show');
                hamburgerBtn.classList.add('active');
            }
        }

        // Toggle developer options visibility
        function toggleDevOptions() {
            const devOptions = document.getElementById('devOptions');
            const showDevToggle = document.getElementById('showDevOptionsToggle');
            
            if (showDevToggle.checked) {
                devOptions.classList.add('show');
            } else {
                devOptions.classList.remove('show');
            }
            
            // Also update debug mode visibility based on current debug mode setting
            const debugModeToggle = document.getElementById('debugModeToggle');
            if (debugModeToggle) {
                updateDebugModeVisibility(debugModeToggle.checked);
            }
        }

        // Apply settings and restart
        function applySettings() {
            addLogEntry('Applying settings and restarting...', 'info');
            
            // Close dropdown if open
            const dropdownContent = document.getElementById('dropdownContent');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            dropdownContent.classList.remove('show');
            hamburgerBtn.classList.remove('active');
            
            // Call restart API
            fetch('/api/restart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                // Even if we get a response, the server is restarting
                addLogEntry('Application restarting... Please wait for page refresh.', 'info');
                
                // Start checking for server availability
                checkServerRestart();
            })
            .catch(error => {
                // This is expected when the server restarts
                addLogEntry('Server restarting... Please wait for page refresh.', 'info');
                checkServerRestart();
            });
        }

        // Check if server has restarted and refresh page
        function checkServerRestart() {
            let attempts = 0;
            const maxAttempts = 30; // 30 seconds max wait
            
            const checkInterval = setInterval(() => {
                attempts++;
                
                fetch('/api/status')
                .then(response => {
                    if (response.ok) {
                        clearInterval(checkInterval);
                        addLogEntry('Server restarted successfully! Refreshing page...', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                })
                .catch(error => {
                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        addLogEntry('Server restart timeout. Please refresh manually.', 'warning');
                    }
                });
            }, 1000);
        }

        // Update uptime
        function updateUptime() {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Update uptime every second
        setInterval(updateUptime, 1000);

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.dropdown');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            
            if (!dropdown.contains(event.target)) {
                const dropdownContent = document.getElementById('dropdownContent');
                dropdownContent.classList.remove('show');
                hamburgerBtn.classList.remove('active');
            }
        });

        // Drops data management
        let dropsData = null;
        let dropsUpdateInterval = null;

        // Fetch drops data from API
        function fetchDropsData() {
            fetch('/api/drops')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching drops data:', data.error);
                        addLogEntry('Failed to fetch drops data: ' + data.error, 'error');
                        return;
                    }
                    
                    dropsData = data;
                    updateDropsDisplay();
                    addLogEntry('Drops data updated', 'info');
                })
                .catch(error => {
                    console.error('Error fetching drops data:', error);
                    addLogEntry('Failed to fetch drops data: ' + error, 'error');
                });
        }

        // Update the drops display with current data
        function updateDropsDisplay() {
            if (!dropsData) return;

            // Update counts
            document.getElementById('inProgressCount').textContent = dropsData.in_progress.length;
            document.getElementById('notStartedCount').textContent = dropsData.not_started.length;
            document.getElementById('completedCount').textContent = dropsData.completed.length;

            // Update current working item
            updateCurrentWorkingItem(dropsData.current_working);

            // Update each section
            updateDropsSection('inProgressDrops', dropsData.in_progress, 'in-progress');
            updateDropsSection('notStartedDrops', dropsData.not_started, 'not-started');
            updateDropsSection('completedDrops', dropsData.completed, 'completed');
        }

        // Update current working item display
        function updateCurrentWorkingItem(currentWorking) {
            const section = document.getElementById('currentWorkingSection');
            const itemContainer = document.getElementById('currentWorkingItem');
            
            if (!currentWorking) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            // Create item media element
            let itemMediaElement = '';
            let itemPlaceholder = '';
            
            if (currentWorking.video) {
                if (currentWorking.video.includes('.mp4') || currentWorking.video.includes('.webm') || currentWorking.video.includes('video')) {
                    itemMediaElement = `<video class="current-working-media" autoplay muted loop>
                        <source src="${currentWorking.video}" type="video/mp4">
                    </video>`;
                } else {
                    itemMediaElement = `<img src="${currentWorking.video}" alt="${currentWorking.item}" class="current-working-media">`;
                }
            }
            
            // Create placeholder for item if no video
            if (!currentWorking.video) {
                const placeholderText = currentWorking.item ? currentWorking.item.charAt(0).toUpperCase() : '?';
                itemPlaceholder = `<div class="current-working-media" style="display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">${placeholderText}</div>`;
            }
            
            // Create streamer avatar element (for streamer drops)
            let streamerAvatarElement = '';
            let streamerPlaceholder = '';
            if (currentWorking.type === 'streamer') {
                if (currentWorking.streamer_avatar) {
                    streamerAvatarElement = `<img src="${currentWorking.streamer_avatar}" alt="${currentWorking.streamer}" class="current-working-media">`;
                }
                
                // Create placeholder for streamer avatar if no avatar
                if (!currentWorking.streamer_avatar) {
                    const streamerPlaceholderText = currentWorking.streamer ? currentWorking.streamer.charAt(0).toUpperCase() : '?';
                    streamerPlaceholder = `<div class="current-working-media" style="display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">${streamerPlaceholderText}</div>`;
                }
            }
            
            // Create streamer info
            let streamerInfo = '';
            if (currentWorking.streamer) {
                streamerInfo = `<div class="current-working-streamer">${currentWorking.streamer}</div>`;
            }
            
            itemContainer.innerHTML = `
                <div class="current-working-info">
                    <div class="current-working-media-container">
                        <div class="media-box">
                            ${itemMediaElement}
                            ${itemPlaceholder}
                        </div>
                        ${streamerAvatarElement ? `<div class="media-box">${streamerAvatarElement}${streamerPlaceholder}</div>` : ''}
                    </div>
                    <div class="current-working-details">
                        <div class="current-working-item-name">${currentWorking.item}</div>
                        ${streamerInfo}
                        <div class="current-working-status">${currentWorking.status || 'WORKING'}</div>
                    </div>
                </div>
            `;
        }

        // Update a specific drops section
        function updateDropsSection(containerId, drops, statusClass) {
            const container = document.getElementById(containerId);
            
            if (drops.length === 0) {
                let message = 'No drops in this category';
                if (statusClass === 'in-progress' && !dropsData) {
                    message = 'Waiting for drops data...';
                } else if (statusClass === 'not-started' && !dropsData) {
                    message = 'Waiting for drops data...';
                } else if (statusClass === 'completed' && !dropsData) {
                    message = 'Waiting for drops data...';
                }
                container.innerHTML = `<div class="no-drops">${message}</div>`;
                return;
            }

            container.innerHTML = drops.map(drop => createDropCard(drop, statusClass)).join('');
        }

        // Create a drop card HTML element
        function createDropCard(drop, statusClass) {
            const progress = drop.progress || 0;
            const progressPercent = Math.min(Math.max(progress, 0), 100);
            
            // Determine progress bar class
            let progressBarClass = '';
            if (statusClass === 'in-progress') {
                progressBarClass = 'in-progress';
            } else if (statusClass === 'completed') {
                progressBarClass = 'completed';
            }

            // Create item video/image element
            let itemMediaElement = '';
            let itemPlaceholder = '';
            
            if (drop.video) {
                // Check if it's a video file
                if (drop.video.includes('.mp4') || drop.video.includes('.webm') || drop.video.includes('video')) {
                    itemMediaElement = `<video class="drop-image" autoplay muted loop onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.nextElementSibling.style.display='none';">
                        <source src="${drop.video}" type="video/mp4">
                    </video>`;
                } else {
                    // Fallback to image
                    itemMediaElement = `<img src="${drop.video}" alt="${drop.item}" class="drop-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.nextElementSibling.style.display='none';">`;
                }
            }
            
            // Create placeholder for item if no video
            if (!drop.video) {
                const placeholderText = drop.item ? drop.item.charAt(0).toUpperCase() : '?';
                itemPlaceholder = `<div class="drop-image-placeholder">${placeholderText}</div>`;
            } else {
                itemPlaceholder = `<div class="drop-image-placeholder" style="display: none;">${drop.item ? drop.item.charAt(0).toUpperCase() : '?'}</div>`;
            }
            
            // Create streamer avatar element (for streamer drops)
            let streamerAvatarElement = '';
            let streamerPlaceholder = '';
            if (drop.type === 'streamer') {
                if (drop.streamer_avatar) {
                    streamerAvatarElement = `<img src="${drop.streamer_avatar}" alt="${drop.streamer}" class="drop-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.nextElementSibling.style.display='none';">`;
                }
                
                // Create placeholder for streamer avatar if no avatar
                if (!drop.streamer_avatar) {
                    const streamerPlaceholderText = drop.streamer ? drop.streamer.charAt(0).toUpperCase() : '?';
                    streamerPlaceholder = `<div class="drop-image-placeholder">${streamerPlaceholderText}</div>`;
                } else {
                    streamerPlaceholder = `<div class="drop-image-placeholder" style="display: none;">${drop.streamer ? drop.streamer.charAt(0).toUpperCase() : '?'}</div>`;
                }
            }

            // Create streamer info for streamer drops
            let streamerInfo = '';
            if (drop.type === 'streamer') {
                const liveStatus = drop.is_live ? 'status-live' : 'status-offline';
                const liveText = drop.is_live ? 'LIVE' : 'OFFLINE';
                streamerInfo = `
                    <div class="drop-streamer">${drop.streamer}</div>
                    <div class="drop-status">
                        <span class="status-indicator ${liveStatus}"></span>
                        <span>${liveText}</span>
                    </div>
                `;
            }
            
            // Show progress title if available (the actual title from Twitch inventory)
            let progressTitleInfo = '';
            if (drop.progress_title && drop.progress_title !== drop.item) {
                progressTitleInfo = `<div class="drop-progress-title">${drop.progress_title}</div>`;
            }

            // Create progress bar (only for in-progress items)
            let progressBar = '';
            if (statusClass === 'in-progress' && progress !== null) {
                progressBar = `
                    <div class="drop-progress">
                        <div class="progress-bar">
                            <div class="progress-fill ${progressBarClass}" style="width: ${progressPercent}%"></div>
                        </div>
                        <div class="progress-text">
                            <span>Progress</span>
                            <span>${progressPercent}%</span>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="drop-card ${statusClass}">
                    <div class="drop-header">
                        <div class="drop-media-container">
                            <div class="media-box">
                                ${itemMediaElement}
                                ${itemPlaceholder}
                            </div>
                            ${streamerAvatarElement ? `<div class="media-box">${streamerAvatarElement}${streamerPlaceholder}</div>` : ''}
                        </div>
                        <div class="drop-info">
                            <div class="drop-title">${drop.item}</div>
                            ${streamerInfo}
                            ${progressTitleInfo}
                            <div class="drop-type">${drop.type.toUpperCase()} DROP</div>
                        </div>
                    </div>
                    ${progressBar}
                    <div class="drop-details">
                        <div class="drop-hours">${drop.hours || 0}h</div>
                        ${statusClass === 'completed' ? '<div class="drop-status"><span class="status-indicator status-completed"></span><span>COMPLETED</span></div>' : ''}
                    </div>
                </div>
            `;
        }

        // Request drops update via WebSocket
        function requestDropsUpdate() {
            if (socket.connected) {
                socket.emit('request_drops_update');
            } else {
                // Fallback to HTTP API if WebSocket not connected
                fetchDropsData();
            }
        }

        // Start periodic drops updates
        function startDropsUpdates() {
            // Initial fetch
            requestDropsUpdate();
            
            // Set up periodic updates every 60 seconds to match debug console frequency
            dropsUpdateInterval = setInterval(requestDropsUpdate, 60000);
        }

        // Stop drops updates
        function stopDropsUpdates() {
            if (dropsUpdateInterval) {
                clearInterval(dropsUpdateInterval);
                dropsUpdateInterval = null;
            }
        }

        // Auto-reload functionality
        let lastHeartbeat = Date.now();
        let heartbeatInterval;
        let reloadTimeout;

        function startHeartbeat() {
            heartbeatInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/status', { 
                        method: 'GET',
                        signal: AbortSignal.timeout(5000) // 5 second timeout
                    });
                    
                    if (response.ok) {
                        lastHeartbeat = Date.now();
                        // Clear any pending reload
                        if (reloadTimeout) {
                            clearTimeout(reloadTimeout);
                            reloadTimeout = null;
                        }
                    } else {
                        console.warn('Heartbeat failed, response not ok');
                        scheduleReload();
                    }
                } catch (error) {
                    console.warn('Heartbeat failed:', error);
                    scheduleReload();
                }
            }, 10000); // Check every 10 seconds
        }

        function scheduleReload() {
            if (reloadTimeout) return; // Already scheduled
            
            const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;
            if (timeSinceLastHeartbeat > 30000) { // 30 seconds without heartbeat
                console.log('No heartbeat for 30+ seconds, scheduling reload...');
                reloadTimeout = setTimeout(() => {
                    console.log('Reloading page due to connection issues...');
                    window.location.reload();
                }, 5000); // Wait 5 more seconds before reloading
            }
        }

        // Update functionality
        async function checkForUpdates() {
            const updateBtn = document.getElementById('updateBtn');
            const originalText = updateBtn.textContent;
            
            try {
                updateBtn.disabled = true;
                updateBtn.textContent = 'üîÑ Checking...';
                
                const response = await fetch('/api/check-updates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(15000) // 15 second timeout
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.update_available) {
                        const updateMessage = `Update available!\n\nCurrent commit: ${result.current_commit}\nLatest commit: ${result.latest_commit}\n\nLatest changes:\n${result.release_notes}\n\nWould you like to update now?`;
                        const shouldUpdate = confirm(updateMessage);
                        
                        if (shouldUpdate) {
                            updateBtn.textContent = '‚¨áÔ∏è Downloading...';
                            await performUpdate();
                        }
                    } else {
                        alert('You are already running the latest version!');
                    }
                } else {
                    alert(`Error checking for updates: ${result.message}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    alert('Update check timed out. Please try again.');
                } else {
                    alert(`Error checking for updates: ${error.message}`);
                }
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
            }
        }

        async function performUpdate() {
            const updateBtn = document.getElementById('updateBtn');
            
            try {
                updateBtn.textContent = '‚¨áÔ∏è Downloading...';
                
                const response = await fetch('/api/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(300000) // 5 minute timeout for update (includes dependency installation)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.restart) {
                        alert('Update completed successfully!\n\n‚úÖ Files updated\n‚úÖ Dependencies installed/updated\n‚úÖ Playwright browsers updated\n\nThe application will restart in a few seconds.');
                        
                        // Wait a moment for the server to restart, then refresh the page
                        setTimeout(() => {
                            console.log('Refreshing page after update...');
                            window.location.reload();
                        }, 5000); // Wait 5 seconds for restart
                    } else {
                        alert('Update completed successfully!\n\n‚úÖ Files updated\n‚úÖ Dependencies installed/updated\n‚úÖ Playwright browsers updated');
                    }
                } else {
                    alert(`Update failed: ${result.message}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    alert('Update timed out. This might be due to slow internet or dependency installation. Please try again or restart the application manually.');
                } else {
                    alert(`Update failed: ${error.message}`);
                }
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'üîÑ Check for Updates';
            }
        }

        // Initial status fetch and settings load
        refreshStatus();
        loadSettings();
        startDropsUpdates();
        startHeartbeat();
    </script>
</body>
</html>

